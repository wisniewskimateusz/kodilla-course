CREATE TABLE STATS(
    STAT_ID   INT(11) AUTO_INCREMENT PRIMARY KEY,
    STAT_DATE DATETIME    NOT NULL,
    STAT      VARCHAR(20) NOT NULL,
    VALUE     INT(11)     NOT NULL
);

CREATE VIEW BESTSELLERS_COUNT AS

SELECT COUNT(*) AS BESTSELLERS
FROM BOOKS
WHERE BESTSELLER = true;

USE kodilla_course;

set global log_bin_trust_function_creators = 1;

DELIMITER $$

CREATE EVENT UPDATE_BESTSELLERS_COUNT
    ON SCHEDULE EVERY 1 MINUTE
    DO
    BEGIN
        CALL UpdateBestsellers();
        INSERT INTO STATS (STAT_DATE, STAT, VALUE)
        VALUES (CURRENT_TIMESTAMP, 'Bestsellers', (SELECT * FROM BESTSELLERS_COUNT));
        COMMIT;
    END $$

DELIMITER ;

SHOW PROCESSLIST;

DROP EVENT UPDATE_BESTSELLERS_COUNT;